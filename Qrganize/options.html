<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 摘要設定與說明</title>
    <link rel="stylesheet" href="options.css">
</head>
<body>
<div class="container">
    <header>
        <h1>Ollama 本地 AI 網頁重點摘要 - 設定與說明</h1>
    </header>

    <main>
        <section id="settings-section" class="settings-card">
            <h2><span class="icon">⚙️</span> 設定 (Settings)</h2>
            <form id="settings-form">
                <div class="form-group">
                    <label for="detail-medium">摘要詳細程度:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="detail" value="low" id="detail-low"> 精簡</label>
                        <label><input type="radio" name="detail" value="medium" id="detail-medium" checked> 中等</label>
                        <label><input type="radio" name="detail" value="high" id="detail-high"> 詳細</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="aiProvider">AI 提供者:</label>
                    <select id="aiProvider" name="aiProvider">
                        <option value="ollama">Ollama (本地)</option>
                        <option value="openai">OpenAI</option>
                        <option value="googleai">Google AI (Gemini)</option>
                        <option value="grokai">Groq API (Grok, Llama, etc.)</option>
                    </select>
                    <p class="input-hint">選擇您要使用的 AI 服務。</p>
                </div>

                <div class="form-group">
                    <label for="apiUrl">API 位址 / 端點:</label>
                    <input type="text" id="apiUrl" name="apiUrl" placeholder="例如: http://localhost:11434/api">
                    <p class="input-hint">請填寫服務的基底 API 位址。例如: Ollama (http://localhost:11434/api), OpenAI (https://api.openai.com/v1), Google AI (https://generativelanguage.googleapis.com), Groq API (https://api.groq.com/openai/v1).</p>
                </div>

                <div class="form-group" id="apiKeyFormGroup" style="display: none;">
                    <label for="apiKey">API 金鑰:</label>
                    <input type="password" id="apiKey" name="apiKey">
                    <p class="input-hint">請填寫您的 API 金鑰。此金鑰將安全儲存，僅用於向您選擇的 AI 服務發送請求。</p>
                </div>

                <!-- New Test Connection Button and Status Area -->
                <div class="form-group"> 
                    <button type="button" id="testConnectionBtn" class="button">測試連線</button>
                    <span id="connectionStatus" class="status-message" style="margin-left: 10px;"></span>
                </div>

                <div class="form-group">
                    <label for="model">AI 模型名稱:</label>
                    <input type="text" id="model" name="model" placeholder="例如: qwen2:7b-instruct">
                    <p class="input-hint">請填寫您希望在 Ollama 中使用的模型名稱 (需已在本地下載)。</p>
                </div>

                <div class="form-group">
                    <label for="outputLanguage">AI 輸出語言:</label>
                    <input type="text" id="outputLanguage" name="outputLanguage" placeholder="例如: 繁體中文, English, 日本語">
                    <p class="input-hint">指定 AI 回應內容的目標語言。</p>
                </div>
                <div class="form-group">
                    <label for="font-small">側邊欄字體大小:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="font" value="small" id="font-small"> 小</label>
                        <label><input type="radio" name="font" value="medium" id="font-medium"> 中 (預設)</label>
                        <label><input type="radio" name="font" value="large" id="font-large"> 大</label>
                    </div>
                    <p class="input-hint">調整側邊摘要面板中顯示文字的相對大小。「中」為標準大小。</p>
                </div>

                <div class="form-group">
                    <label for="panelWidth">側邊欄預設寬度 (像素):</label>
                    <input type="number" id="panelWidth" name="panelWidth" min="320" max="800" step="10">
                    <p class="input-hint">側邊欄開啟時的寬度，建議範圍 320px - 800px。</p>
                </div>

                <div class="form-group">
                    <label for="aiTimeout">AI請求超時時間 (秒):</label>
                    <input type="number" id="aiTimeout" name="aiTimeout" min="5" step="1" placeholder="例如: 120">
                    <p class="input-hint">向 Ollama AI 發送請求的等待超時時間 (單位：秒)。預設 120 秒。設定過短可能導致複雜請求因處理不及而失敗。</p>
                </div>

                <div class="form-group switch-group">
                    <label for="showErr">顯示詳細錯誤訊息 (含除錯/重試按鈕):</label>
                    <label class="switch">
                        <input type="checkbox" id="showErr" name="showErr">
                        <span class="slider round"></span>
                    </label>
                    <p class="input-hint">開啟後，錯誤將顯示更詳細技術資訊，摘要面板也會出現「複製原始內容/回應/Prompt」等除錯按鈕，以及在 AI 呼叫失敗時提供「重試」選項。</p>
                </div>

                <div class="action-buttons">
                    <button type="button" id="save" class="button primary">儲存設定</button>
                    <button type="button" id="reset" class="button danger">恢復預設值</button>
                    <span id="save-status" class="status-message"></span>
                </div>
            </form>
        </section>

        <hr class="section-divider">

        <section id="help-section" class="help-card">
            <h2><span class="icon">💡</span> 功能說明 (Features & Usage)</h2>

            <div class="help-category">
                <h3>一、核心摘要功能</h3>
                <ul>
                    <li><strong>自動內文擷取：</strong> 智慧識別並提取網頁主要閱讀內容，過濾廣告、導航等干擾元素。</li>
                    <li><strong>本地 Ollama AI 整合：</strong> 完全使用您在本地部署的 Ollama 服務及選定模型進行摘要，確保資料隱私與模型選擇的自主性。</li>
                    <li><strong>結構化摘要呈現：</strong> AI 生成的摘要將以結構化 JSON 格式回傳，並在側邊欄中以下列方式呈現：
                        <ul>
                            <li><em>重點標題列表：</em> 清晰列出所有摘要重點的標題，方便快速概覽。</li>
                            <li><em>點擊導航：</em> 點擊任一標題，即可平滑捲動至下方對應的詳細說明區塊。</li>
                            <li><em>指定語言輸出：</em> 可在設定中指定 AI 摘要及問答時使用的語言（預設為繁體中文）。</li>
                            <li><em>摘要中引用原文片段：</em> 為增強摘要的可信度與脈絡，AI 可能會在摘要重點的詳細說明中，引用一小段直接相關的原文片段。這些引用的文字會有特殊樣式標註，以利區分。</li>
                        </ul>
                    </li>
                    <li><strong>選取文字即時摘要：</strong> 在網頁上選取任意文字片段，透過右鍵選單或擴充功能圖示，即可對選定範圍進行快速摘要。</li>
                    <li><strong>摘要內容限制：</strong> AI 被引導專注於原始文本中明確提到的信息，避免過度延伸，並根據原文長短調整摘要篇幅。</li>
                    <li><strong>原始文章查閱：</strong> 摘要生成後，您可以在摘要卡片下方找到「<span class="toggle-icon-example">▼</span> 原始文章內容」的按鈕（**預設為收合狀態**），點擊即可展開或收合由擴充功能擷取的網頁原文，方便對照參考。</li>
                    <li><strong>AI請求超時設定：</strong> 您可以在設定頁面調整向 AI 發送請求的等待超時時間 (單位：秒)。</li>
                    <li><strong>除錯與重試輔助：</strong> 當在設定中開啟「顯示詳細錯誤訊息」時：
                        <ul>
                            <li>摘要面板會額外提供「複製摘要Prompt」、「複製原始回應」及「複製原始內容」按鈕。</li>
                            <li>若主要 AI 摘要呼叫失敗，會在錯誤訊息旁提供「重試」按鈕。</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="help-category">
                <h3>二、互動問答 (Q&A)</h3>
                <ul>
                    <li><strong>基於上下文的精準問答：</strong> 您可以針對目前網頁主題、已生成的 AI 摘要重點，以及先前的問答歷史進行提問。AI 被引導嚴格基於這些提供的上下文來回答，避免無關的延伸。</li>
                    <li><strong>指定語言問答：</strong> AI 將以您在設定中指定的語言回答您的提問。</li>
                    <li><strong>Markdown 格式回答：</strong> AI 會使用 Markdown 語法（例如各級標題、項目符號列表等）來排版其回答，經處理後以豐富格式呈現，提升可讀性。問答中若引用上下文，也會以特殊樣式呈現。</li>
                    <li><strong>對話歷史保留：</strong> 問答記錄會顯示在側邊欄中，方便回顧。</li>
                    <li><strong>統一滾動體驗：</strong> 摘要內容與整個 Q&A 區塊（包含歷史記錄和輸入框）均在同一個可滾動區域內，操作流暢。</li>
                    <li><strong>問答錯誤重試：</strong> 若問答過程中 AI 回應失敗，且「顯示詳細錯誤訊息」已開啟，對應的問答條目旁會出現「重試」按鈕，點擊可重新針對該問題提問。</li>
                    <li><strong>除錯輔助：</strong> 當「顯示詳細錯誤訊息」開啟時，每個問答條目的AI回答下方會額外提供「複製Prompt」和「複製AI原始回應」按鈕，方便複製用於該問答的完整提示語及AI未經處理的原始輸出。</li>
                </ul>
            </div>

            <div class="help-category">
                <h3>三、操作方式</h3>
                <ul>
                    <li><strong>擴充功能圖示 (瀏覽器工具列按鈕)：</strong> 點擊此圖示可開啟側邊摘要面板，並自動對當前分頁進行摘要。</li>
                    <li><strong>右鍵選單：</strong>
                        <ul>
                            <li>於網頁任一處點擊右鍵，選擇「AI 摘要（全文或選取）」即可觸發。若已選取文字，則摘要選取部分；否則摘要當前頁面全文。</li>
                            <li>於擴充功能圖示上點擊右鍵（或在某些瀏覽器中是左鍵點擊後出現的選單），選擇「設定 (Settings)」即可進入此設定頁面。</li>
                        </ul>
                    </li>
                    <li><strong>側邊欄主要按鈕：</strong>
                        <ul>
                            <li><em>摘要 (Summarize)：</em> 手動觸發對當前頁面或選取文字的摘要。</li>
                            <li><em>全部清除 (Clear/Cancel)：</em> 清除側邊欄中現有的摘要、問答記錄及已展開的原始文章；若 AI 正在處理主要摘要請求，則可取消該請求。</li>
                            <li><em>關閉 (Close)：</em> 關閉側邊摘要面板。</li>
                            <li><em>複製原始回應 (Copy Raw Response)：</em> (需開啟「顯示詳細錯誤」) 複製 AI 模型未經處理的原始 JSON 格式回應字串。</li>
                            <li><em>複製原始內容 (Copy Source Text)：</em> (需開啟「顯示詳細錯誤」) 複製擴充功能從網頁擷取的原始文本內容。</li>
                            <li><em>複製摘要Prompt (Copy Summary Prompt)：</em> (需開啟「顯示詳細錯誤」) 複製用於生成當前摘要的完整提示語 (Prompt) 內容。</li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="help-category">
                <h3>四、自訂設定選項 (詳見上方表單)</h3>
                <p>您可以透過上方的設定表單，自訂以下選項以符合您的使用習慣：</p>
                <ul>
                    <li><strong>AI 提供者 (AI Provider)：</strong>您可以選擇使用本地運行的 Ollama 服務，或是外部的 OpenAI、Google AI (Gemini) 或 Groq API 服務。Ollama 完全在本地處理，不需 API 金鑰；其他外部服務則需要 API 金鑰。</li>
                    <li><strong>API 位址 / 端點 (API URL / Endpoint)：</strong>根據所選的 AI 提供者，填寫對應的 API 位址。
                        <ul>
                            <li>Ollama：通常是 <code>http://localhost:11434</code> 或 <code>http://localhost:11434/api</code>。擴充功能會自動處理後續路徑。</li>
                            <li>OpenAI：請填寫 API 的基礎位址，通常是 <code>https://api.openai.com/v1</code>。</li>
                            <li>Google AI (Gemini)：請填寫 API 的基礎位址，例如 <code>https://generativelanguage.googleapis.com</code>。</li>
                            <li>Groq API：請填寫 API 的基礎位址，例如 <code>https://api.groq.com/openai/v1</code>。</li>
                        </ul>
                        <p class="input-hint" style="font-size: 0.85em; margin-top: 5px;">提示：API 位址通常不包含模型名稱或 `/chat/completions` 等特定操作路徑，除非該服務有此特殊要求。請參考上方輸入框的提示範例。</p>
                    </li>
                    <li><strong>API 金鑰 (API Key)：</strong>若選擇 OpenAI、Google AI 或 Groq API，則需要在此處填寫您的 API 金鑰。此金鑰通常可以在您註冊的對應 AI 服務供應商的官方網站帳戶管理頁面或開發者設定中找到。API 金鑰將安全地儲存在您的瀏覽器擴充功能設定中。</li>
                    <li><strong>重要 - 外部服務費用：</strong>請注意，當使用 OpenAI、Google AI 或 Groq API 等外部雲端 AI 服務時，您將需要自行負擔可能產生的 API 使用費用。這些費用由各服務供應商根據其定價策略收取，與本擴充功能無關。Ollama 本地服務則無此費用。</li>
                    <li><strong>測試連線按鈕：</strong>在輸入 API 位址（以及 API 金鑰，如適用時）後，您可以使用「測試連線」按鈕來快速確認擴充功能是否能成功連接到您選擇的 AI 服務。測試結果會顯示在按鈕旁。</li>
                    <li><strong>AI 模型名稱 (AI Model Name)：</strong>請填寫您希望使用的 AI 模型具體名稱。例如 Ollama 的 <code>qwen2:7b-instruct</code>，OpenAI 的 <code>gpt-3.5-turbo</code>，Google AI 的 <code>gemini-1.5-flash-latest</code>，或 Groq API 支援的 <code>llama3-8b-8192</code> 等。請確保所選的 AI 提供者能夠存取此模型（例如，Ollama 模型需已在本地下載，外部服務模型需在您的帳戶權限內可用）。</li>
                    <li><strong>摘要詳細程度 (Summary Detail Level)：</strong>選擇 AI 生成摘要的詳細程度 (精簡/中等/詳細)。</li>
                    <li><strong>AI 輸出語言 (AI Output Language)：</strong>指定 AI 回應內容的目標語言 (例如：繁體中文, English, 日本語)。</li>
                    <li><strong>側邊欄字體大小 (Sidebar Font Size)：</strong>調整側邊摘要面板中顯示文字的相對大小 (小/中/大，中為標準)。</li>
                    <li><strong>側邊欄預設寬度 (Sidebar Default Width)：</strong>側邊欄開啟時的寬度（像素值），建議範圍 320px - 800px。</li>
                    <li><strong>AI請求超時時間 (AI Request Timeout)：</strong>向 AI 發送請求的等待超時時間（單位：秒）。預設 120 秒。</li>
                    <li><strong>顯示詳細錯誤訊息 (Show Detailed Errors)：</strong>開啟後，錯誤將顯示更詳細技術資訊，並啟用除錯及重試按鈕。</li>
                </ul>
            </div>

            <div class="help-category">
                <h3>五、技術提示與需求</h3>
                <ul>
                    <li><strong>AI 服務環境：</strong>
                        <ul>
                            <li>若使用 <strong>Ollama</strong>：您必須已在您的電腦上成功安裝並運行 Ollama 服務。請確保在「AI 模型名稱」設定中指定的模型，已經透過 Ollama 指令 (如 `ollama pull your_model_name`) 下載至您的本地 Ollama 環境中。背景服務會定期 (每20秒) ping Ollama API 的 `/api/tags` 端點以嘗試保持連線 (僅當 Ollama 為選定提供者時)。</li>
                            <li>若使用 <strong>OpenAI, Google AI, Groq API</strong>：您需要擁有對應服務的有效帳戶及 API 金鑰。請確保您輸入的 API 位址及金鑰正確無誤，且您的帳戶有權限使用您在「AI 模型名稱」中指定的模型。</li>
                        </ul>
                    </li>
                    <li><strong>API 連線：</strong> 擴充功能需要能夠成功連線到您所設定的「API 位址 / 端點」。您可以使用「測試連線」按鈕進行檢查。</li>
                    <li><strong>UTF-8 編碼：</strong> 為確保最佳相容性與顯示效果，建議您的作業系統、瀏覽器以及所瀏覽的網頁均優先使用 UTF-8 編碼。本擴充功能所有相關檔案（HTML, CSS, JS）均使用 UTF-8 編碼儲存。</li>
                    <li><strong>內容擷取限制：</strong> 對於結構極端複雜或大量依賴 JavaScript 動態載入內容的網頁，主要內文的擷取效果可能會受到一定限制。</li>
                    <li><strong>超時設定：</strong> 若經常遇到 504 Gateway Time-out 錯誤，除了檢查 Ollama 服務效能，也可嘗試在此設定頁面中適當增加「AI請求超時時間」。但請注意，前端超時無法解決後端伺服器 (如 Nginx) 本身的超時問題。</li>
                </ul>
            </div>
        </section>
    </main>

    <footer>
        <p>Ollama 本地 AI 網頁重點摘要 v1.7 (設定與UI調整、程式碼重構)</p>
    </footer>
</div>
<script src="options.js"></script>
</body>
</html>